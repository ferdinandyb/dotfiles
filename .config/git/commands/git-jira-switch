#!/bin/sh

WORKTREE_MODE=0

show_help() {
    cat << EOF
Usage: git jira-switch [OPTIONS] <ticket-number> [base-branch]

Create a branch from JIRA ticket information and switch to it.

Requirements:
  - jira CLI tool (https://github.com/ankitpokhrel/jira-cli)

Options:
  -w, --worktree    Create a worktree instead of switching branches locally
  -h, --help        Show this help message

Arguments:
  ticket-number     JIRA ticket number (e.g., PROJ-123)
  base-branch       Optional base branch to branch from (if omitted, 
                    defaults to origin/HEAD with --no-track)

Examples:
  git jira-switch PROJ-123
  git jira-switch PROJ-123 PROJ-111-dependency-feature
  git jira-switch --worktree PROJ-123
  git jira-switch --worktree PROJ-123 develop
EOF
}

while [ $# -gt 0 ]; do
    case $1 in
        -w|--worktree)
            WORKTREE_MODE=1
            shift
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        -*)
            echo "ERROR: Unknown option $1" 1>&2
            exit 1
            ;;
        *)
            break
            ;;
    esac
done

ticket=$1
base_branch=$2

if [ -z "$ticket" ]; then
    echo "ERROR: Please provide the jira ticket number" 1>&2
    echo ""
    show_help
    exit 1
fi

project=$(echo "$ticket" | cut -d'-' -f1)

jiraBranchName=$(jira -p $project issue list -q "key = $ticket" --plain | awk 'NR==2' | awk -F '\t' '{ print $3 }')
echo ""
if [ -z "$jiraBranchName" ]; then
    echo "ERROR: Please provide valid jira ticket number" 1>&2
    echo ""
    show_help
    exit 1
fi

jirasummary=$(echo "$jiraBranchName" | sed "s/[^[:alpha:].-]/-/g" | tr '[:upper:]' '[:lower:]' | head -c 30)

branchName="$ticket-$jirasummary"

# Set base branch - use provided base_branch if given, otherwise origin/HEAD
if [ -n "$base_branch" ]; then
    base_ref="$base_branch"
    track_flag=""  # Track the specified base branch
else
    base_ref="origin/HEAD"
    track_flag="--no-track"  # Don't track origin/HEAD
fi

if [ "$WORKTREE_MODE" -eq 1 ]; then
    # Get repository name and parent directory for worktree
    # Use the main worktree path to ensure consistent naming
    MAIN_WORKTREE=$(git worktree list --porcelain | head -n 1 | cut -d' ' -f2)
    REPO_NAME=$(basename "$MAIN_WORKTREE")
    PARENT_DIR=$(dirname "$MAIN_WORKTREE")
    WORKTREE_DIR="${PARENT_DIR}/${REPO_NAME}-${branchName}"

    if [ -d "$WORKTREE_DIR" ]; then
        echo "ERROR: Directory $WORKTREE_DIR already exists" 1>&2
        exit 1
    fi

    git worktree add -b "$branchName" "$WORKTREE_DIR" "$base_ref" $track_flag
    echo "Worktree created successfully. To switch:" 
    echo "cd $WORKTREE_DIR"
else
    # Checkout remote branch from where you want to update.
    git switch -c "$branchName" "$base_ref" $track_flag
fi
